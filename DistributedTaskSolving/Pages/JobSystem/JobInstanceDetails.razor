@using DistributedTaskSolving.Application.Shared.Business.JobSystem.JobInstances.Dto;
@using DistributedTaskSolving.Application.Shared.Business.JobSystem.WorkUnits.Dto
@using MediatR
@using DistributedTaskSolving.Application.Business.JobSystem.WorkUnits.QueryHandlers
@using ChartJs.Blazor.Charts
@using ChartJs.Blazor.ChartJS.PieChart
@using ChartJs.Blazor.ChartJS.Common.Properties
@using ChartJs.Blazor.Util
@inherits GridReadComponent<JobInstanceDto>
@inject IMediator Mediator

<h2>Job Instance @Item.Id</h2>


<div>Key: @Item.Key</div>
<div>Result: @(string.IsNullOrEmpty(Item.Result) ? "n/a" : Item.Result)</div>

<div>Started on: @Item.CreationDateTime</div>

@if (Item.IsSolved)
{
    <div>Finished on: @Item.FinishDateTime</div>
}

<div>Real time: @(((Item.FinishDateTime ?? DateTime.UtcNow) - Item.CreationDateTime).ToString("c"))</div>

@if (_workUnits != null)
{
    <div>CPU time: @_cpuTime.ToString("c")</div>
    <div>Work unit count: @_workUnits.Count</div>

    <div class="row">
        <div class="col-lg-4 col-md-6 col-12">
            <ChartJsPieChart @ref="_programmingLanguagePieChartJs" Config="@_programmingLanguagePieConfig" />
        </div>
        <div class="col-lg-4 col-md-6 col-12">
            <ChartJsPieChart @ref="_algorithmPieChartJs" Config="@_algorithmPieConfig" />
        </div>
    </div>
}

@code
{
    List<WorkUnitDto> _workUnits;
    TimeSpan _cpuTime;
    PieConfig _programmingLanguagePieConfig;
    ChartJsPieChart _programmingLanguagePieChartJs;
    PieConfig _algorithmPieConfig;
    ChartJsPieChart _algorithmPieChartJs;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkUnits();

        LoadProgrammingLanguagePieChart();
        LoadAlgorithmPieChart();
    }

    public async Task LoadWorkUnits()
    {
        _workUnits = await Mediator.Send(new WorkUnitForJobInstanceQuery
        {
            Id = Item.Id
        });

        var cpuTimes = _workUnits.Select(x => new
        {
            CpuTime = x.SubmitDateTime == null ? TimeSpan.Zero : (DateTime)x.SubmitDateTime - x.CreationDateTime
        });

        _cpuTime = new TimeSpan(cpuTimes.Sum(r => r.CpuTime.Ticks));

        StateHasChanged();
    }

    public void LoadProgrammingLanguagePieChart()
    {
        _programmingLanguagePieConfig = new PieConfig
        {
            Options = new PieOptions
            {
                Title = new OptionsTitle
                {
                    Display = true,
                    Text = "Programming Language usage"
                },
                Responsive = true,
                Animation = new ArcAnimation
                {
                    AnimateRotate = true,
                    AnimateScale = true
                }
            }
        };

        var workUnitsGroupedByProgrammingLanguage = _workUnits.GroupBy(_ => _.ProgrammingLanguageName).ToList();

        _programmingLanguagePieConfig.Data.Labels.AddRange(
            workUnitsGroupedByProgrammingLanguage.Select(x => string.IsNullOrEmpty(x.Key) ? "Other" : x.Key)
            );

        var pieSet = new PieDataset
        {
            BackgroundColor = new[] { ColorUtil.RandomColorString(), ColorUtil.RandomColorString(), ColorUtil.RandomColorString(), ColorUtil.RandomColorString() },
            BorderWidth = 0,
            HoverBackgroundColor = ColorUtil.RandomColorString(),
            HoverBorderColor = ColorUtil.RandomColorString(),
            HoverBorderWidth = 1,
            BorderColor = "#ffffff",
        };

        pieSet.Data.AddRange(workUnitsGroupedByProgrammingLanguage.Select(_ => (double)_.Count()));

        _programmingLanguagePieConfig.Data.Datasets.Add(pieSet);
    }

    public void LoadAlgorithmPieChart()
    {
        _algorithmPieConfig = new PieConfig
        {
            Options = new PieOptions
            {
                Title = new OptionsTitle
                {
                    Display = true,
                    Text = "Algorithm usage"
                },
                Responsive = true,
                Animation = new ArcAnimation
                {
                    AnimateRotate = true,
                    AnimateScale = true
                }
            }
        };

        var workUnitsGroupedByAlgorithm = _workUnits.GroupBy(_ => _.AlgorithmName).ToList();

        _algorithmPieConfig.Data.Labels.AddRange(
        workUnitsGroupedByAlgorithm.Select(x => string.IsNullOrEmpty(x.Key) ? "Other" : x.Key)
        );

        var pieSet = new PieDataset
        {
            BackgroundColor = new[] { ColorUtil.RandomColorString(), ColorUtil.RandomColorString(), ColorUtil.RandomColorString(), ColorUtil.RandomColorString() },
            BorderWidth = 0,
            HoverBackgroundColor = ColorUtil.RandomColorString(),
            HoverBorderColor = ColorUtil.RandomColorString(),
            HoverBorderWidth = 1,
            BorderColor = "#ffffff",
        };

        pieSet.Data.AddRange(workUnitsGroupedByAlgorithm.Select(_ => (double)_.Count()));

        _algorithmPieConfig.Data.Datasets.Add(pieSet);
    }
}
